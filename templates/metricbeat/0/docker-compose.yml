version: '2'
services:
  metricbeat-config:
    restart: always
    image: artifactory.devops.itaas-cloud.com:6553/metricbeat_config:latest
    volumes:
     - /usr/share/metricbeat/metricbeat.yml
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.container.pull_image: always
      io.rancher.container.start_once: true
  metricbeat:
    image: docker.elastic.co/beats/metricbeat:5.6.2
    stdin_open: true
    #net: "host"
    environment:
      PERIOD: ${input_period}
      #DOCKER_SOCKET: ${input_socket}
      LOGSTASH_HOSTS: ${logstash_url}
      LOGSTASH_WORKERS: ${logstash_workers}
      LOGSTASH_COMPRESSION_LEVEL: ${logstash_compression}
      ENVIRONMENT_ENV: ${environment_env}

      #DOCKER_ENABLE_TLS: ${input_tls_enable}
      #DOCKER_CA_PATH: ${input_tls_ca_path}
      #DOCKER_CERT_PATH: ${input_tls_cert_path}
      #DOCKER_KEY_PATH: ${input_tls_key_path}
    external_links:
    - ${logstash_source}
    tty: true
    volumes:
    - /proc:/hostfs/proc:ro
    - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
    - /var/run/docker.sock:/var/run/docker.sock
    - /:/hostfs:ro
    volumes_from:
    - metricbeat-config
    labels:
      io.rancher.sidekicks: metricbeat-config
      io.rancher.container.hostname_override: container_name
      io.rancher.container.pull_image: always
      io.rancher.scheduler.global: 'true'
      