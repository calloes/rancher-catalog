version: '2'
volumes:
  esdatamaster:
    driver: local
services:
  elasticsearch-masters:
    mem_limit: 1073741824
    cap_add:
    - IPC_LOCK
    image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
    environment:
      ES_JAVA_OPTS: $javamastermemory
      bootstrap.memory_lock: 'true'
      cluster.name: docker-cluster
      discovery.zen.minimum_master_nodes: '1'
      discovery.zen.ping.unicast.hosts: elasticsearch-masters
      node.max_local_storage_nodes: '3'
      node.master: 'true'
      node.data: 'false'
      node.ingest: 'false'
    ulimits:
      memlock:
        hard: -1
        soft: -1
      nofile:
        hard: 65536
        soft: 65536
    volumes_from:
    - elasticmaster-data
    volumes:
    - /usr/share/elasticsearch/config
    #ports:
    #- 9200:9200/tcp
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.sidekicks: elasticmaster-data
      io.rancher.scheduler.global: 'true'
  elasticmaster-data:
      entrypoint:
      - /bin/true
      network_mode: none
      labels:
        io.rancher.container.hostname_override: container_name
        io.rancher.container.start_once: true
      volumes:
      - /usr/share/elasticsearch/data
      image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
  elasticsearch-data:
      mem_limit: 1073741824
      cap_add:
      - IPC_LOCK
      image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
      environment:
        ES_JAVA_OPTS: $javadatamemory
        bootstrap.memory_lock: 'true'
        cluster.name: docker-cluster
        discovery.zen.minimum_master_nodes: '2'
        discovery.zen.ping.unicast.hosts: elasticsearch-masters
        node.max_local_storage_nodes: '3'
        node.master: 'false'
        node.data: 'true'
        node.ingest: 'false'
      ulimits:
        memlock:
          hard: -1
          soft: -1
        nofile:
          hard: 65536
          soft: 65536
      volumes_from:
      - elasticdata-data
      volumes:
      - /usr/share/elasticsearch/config
      #ports:
      #- 9200:9200/tcp
      labels:
        io.rancher.container.hostname_override: container_name
        io.rancher.sidekicks: elasticdata-data
        io.rancher.scheduler.global: 'true'
  elasticdata-data:
        entrypoint:
        - /bin/true
        network_mode: none
        labels:
          io.rancher.container.hostname_override: container_name
          io.rancher.container.start_once: true
        volumes:
        - /usr/share/elasticsearch/data
        image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
  elasticsearch-ingest:
      mem_limit: 1073741824
      cap_add:
      - IPC_LOCK
      image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
      environment:
        ES_JAVA_OPTS: $javaingestmemory
        bootstrap.memory_lock: 'true'
        cluster.name: docker-cluster
        discovery.zen.minimum_master_nodes: '2'
        discovery.zen.ping.unicast.hosts: elasticsearch-masters
        node.max_local_storage_nodes: '3'
        node.master: 'false'
        node.data: 'false'
        node.ingest: 'true'
      ulimits:
        memlock:
          hard: -1
          soft: -1
        nofile:
          hard: 65536
          soft: 65536
      volumes_from:
      - elasticingest-data
      volumes:
      - /usr/share/elasticsearch/config
      ports:
      - 9200:9200/tcp
      labels:
        io.rancher.container.hostname_override: container_name
        io.rancher.sidekicks: elasticingest-data
        io.rancher.scheduler.global: 'true'
  elasticingest-data:
        entrypoint:
        - /bin/true
        network_mode: none
        labels:
          io.rancher.container.hostname_override: container_name
          io.rancher.container.start_once: true
        volumes:
        - /usr/share/elasticsearch/data
        image: docker.elastic.co/elasticsearch/elasticsearch:5.3.0
  logstash:
    image: docker.elastic.co/logstash/logstash:5.3.0
    volumes_from:
    - logstash-config
    links:
    - elasticsearch-ingest:elasticsearch
    ports:
      # Beats input -- https://www.elastic.co/guide/en/logstash/5.0/plugins-inputs-beats.html
      - '5044:5044'
      # UDP input -- https://www.elastic.co/guide/en/logstash/master/plugins-inputs-udp.html#plugins-inputs-udp-codec
      - '43448:43448/udp'
      # Monitoring APIs -- https://www.elastic.co/guide/en/logstash/5.0/monitoring.html
      - '9600:9600'
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.sidekicks: logstash-config
  logstash-config:
    entrypoint:
    - /bin/true
    network_mode: none
    labels:
      io.rancher.container.hostname_override: container_name
      io.rancher.container.start_once: true
    volumes:
    #- /usr/share/logstash/config/
    - /usr/share/logstash/pipeline/
    image: artifactory.devops.itaas-cloud.com:6443/logstash-53-config
  kibana:
    image: docker.elastic.co/kibana/kibana:5.3.0
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 5601
    #volumes:
    #- /etc/kibana/
    links:
    - elasticsearch-ingest:elasticsearch
    ports:
    - 5601:5601/tcp
    labels:
      io.rancher.container.hostname_override: container_name
